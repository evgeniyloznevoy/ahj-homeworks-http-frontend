!function(){"use strict";const t=new class{constructor(){this.status=document.querySelector("[data-id=status]"),this.title=document.querySelector("[data-id=title]"),this.data=document.querySelector("[data-id=data]"),this.list=document.querySelector(".list"),this.modal=document.querySelector(".modal"),this.widget=document.querySelector(".ticketswidget")}rowTemplate(t,e,i,s){return`\n      <div class='row' data-id=${t}>\n        <div data-id='status'>${e}</div>\n        <div class='title' data-id='title'>${i}</div>\n        <div class='data' data-id='data'>${s}</div>\n        <div><button data-id='edit'>✎</button></div>\n        <div><button data-id='del'>✖</button></div>\n      </div>\n      `}editTemplate(t,e,i,s,d){return`\n      <form name=${s} data-idfor="${d}">\n        <h3>${t}</h3>\n        Краткое описание <input type="text" name='title' value="${e}"><br>\n        Подробное описание <input type="text" name='description' value="${i}"><br>\n        <button type="reset">Отмена</button>\n        <button type="submit">Ок</button> \n      </form>\n      `}descriptionTemplate(t){return`\n      <p>${t}</p>\n      `}delTemplate(t){return`\n      <form name='del' data-idfor="${t}">\n        <h3>Удалить тикет</h3>\n        <p>Вы уверены, что хотите удалить тикет? Это действие необратимо</p>\n        <button type="reset">Отмена</button>\n        <button type="submit">ОК</button>\n      </form>\n      `}},e=new class{constructor(t){this.gui=t,this.tickets=null,this.url="https://ahj-homeworks-http-backend.herokuapp.com/",this.modalSubmit=this.modalSubmit.bind(this),this.modalReset=this.modalReset.bind(this)}init(){this.getTickets(),this.gui.widget.addEventListener("click",(t=>{t.preventDefault(),"edit"===t.target.dataset.id?this.editTicket(t):"del"===t.target.dataset.id?this.delTicket(t):"title"===t.target.dataset.id?this.showDescription(t):"add"===t.target.dataset.id&&this.addTicket(t)}))}async sendXHR(t,e,i){const s=new XMLHttpRequest;if("GET"===t){const i=`${this.url}?method=${e}`;s.open(t,i,!1),s.send()}else if("POST"===t){const d=`${this.url}?method=${i}`;s.open(t,d,!1),s.send(e)}else if("DELETE"===t){const i=`${this.url}?method=deleteTicket&id=${e}`;s.open(t,i,!1),s.send()}return s.response}async getTickets(){const t=JSON.parse(await this.sendXHR("GET","allTickets"));this.tickets=t,this.fillFields(this.tickets)}fillFields(t){this.gui.list.innerHTML="",t.forEach((t=>{this.gui.list.innerHTML+=this.gui.rowTemplate(t.id,t.status,t.name,t.created)}))}async modalSubmit(t){t.preventDefault();const{name:e}=t.target,i=t.target.dataset.idfor;if("edit"===e){const t=new FormData(document.forms[1]);t.append("id",i),await this.sendXHR("POST",t,"editTicket")}else if("del"===e){const t=i;this.sendXHR("DELETE",t)}else if("createTicket"===e){const t=new FormData(document.forms[1]),e=JSON.parse(await this.sendXHR("POST",t,"createTicket"));this.gui.list.innerHTML+=this.gui.rowTemplate(e.id,e.status,e.name,e.created)}this.getTickets(),this.gui.modal.removeEventListener("submit",this.modalSubmit),await this.gui.modal.classList.add("hidden")}modalReset(t){t.preventDefault(),this.gui.modal.classList.add("hidden"),this.gui.modal.removeEventListener("reset",this.modalReset)}delTicket(t){const{id:e}=t.target.closest(".row").dataset;this.gui.modal.classList.remove("hidden"),this.gui.modal.innerHTML=this.gui.delTemplate(e),this.gui.modal.addEventListener("submit",this.modalSubmit),this.gui.modal.addEventListener("reset",this.modalReset)}addTicket(){this.gui.modal.classList.remove("hidden"),this.gui.modal.innerHTML=this.gui.editTemplate("Добавить тикет","","","createTicket"),this.gui.modal.addEventListener("submit",this.modalSubmit),this.gui.modal.addEventListener("reset",this.modalReset)}async showDescription(t){if(t.target.children[0])t.target.removeChild(t.target.children[0]);else{const{id:e}=t.target.parentElement.dataset,i=JSON.parse(await this.sendXHR("GET",`ticketById&id=${e}`));t.target.innerHTML+=this.gui.descriptionTemplate(i.description)}}async editTicket(t){this.gui.modal.classList.remove("hidden");const{id:e}=t.target.closest(".row").dataset,i=JSON.parse(await this.sendXHR("GET",`ticketById&id=${e}`));this.gui.modal.innerHTML=this.gui.editTemplate("Изменить тикет",i.name,i.description,"edit",e),this.gui.modal.addEventListener("submit",this.modalSubmit),this.gui.modal.addEventListener("reset",this.modalReset)}}(t);e.init()}();